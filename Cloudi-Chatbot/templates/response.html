<!-- This is Cloudi's response page -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cloudi's Response ☁️</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <h1 class="cloudi-title">Cloudi says... ☁️</h1>

  <!-- Toggles -->
  <button id="theme-toggle" onclick="toggleDarkMode()">🌙</button>
  <button id="voice-toggle" class="theme-toggle" onclick="toggleVoice()">🔊</button>
  <button class="copy-btn" onclick="copyToClipboard()">📋 Copy Answer</button>

  <p class="cloudi-mode">
    Cloudi is currently in <strong>{{ session['personality'].capitalize() }}</strong> mode 🎭
  </p>

  <!-- Typing Indicator -->
  <div id="cloudi-typing" class="typing-dots">
    Cloudi is typing<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span>
  </div>

  {% if not is_casual %}
    <div class="chat-bubble user">
      <div class="avatar">👩‍💻</div>
      <div class="bubble-content">
        <strong>You:</strong> {{ question }}
        <p class="username">— You</p>
      </div>
    </div>

    <div class="chat-bubble cloudi" id="cloudi-response">
      <div class="avatar">🤖</div>
      <div class="bubble-content">
        <strong>Cloudi:</strong>
        <div id="cloudi-answer">{{ answer | safe }}</div>
        <p class="cloudi-signature">— Cloudi ☁️</p>
      </div>
    </div>
  {% endif %}

  <!-- Ask again link -->
  <div class="centered-link">
    <a href="/">⬅️ Ask anything</a>
  </div>

  <!-- Feedback Button -->
  <div class="feedback-button">
    <button onclick="openFeedbackModal()">💬 Give Feedback</button>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback-modal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeFeedbackModal()">&times;</span>
      <h3>💭 Your Feedback</h3>
      <form action="/submit-feedback" method="POST">
        <textarea name="feedback" rows="4" placeholder="Tell us what you think..." required></textarea>
        <input type="hidden" name="question" value="{{ question }}">
        <input type="hidden" name="answer" value="{{ answer }}">
        <button type="submit">Submit</button>
      </form>
    </div>
  </div>

  {% if history %}
  <div class="actions-container">
    <button id="toggle-history" onclick="toggleHistory()">📂 Show Chat History</button>
  </div>

  <div id="history-container" class="chat-container history-container">
    <h2>🗂️ Your Chat History:</h2>
    {% for entry in history %}
      <div class="faq-item">
        <div class="faq-question" onclick="toggleFaq(this)">
          ▶️ <strong>You asked:</strong> {{ entry.question }}
        </div>
        <div class="faq-answer">
          <div class="chat-bubble user">
            <div class="avatar">👩‍💻</div>
            <div class="bubble-content">
              <strong>You:</strong> {{ entry.question }}
            </div>
          </div>
          <div class="chat-bubble cloudi">
            <div class="avatar">🤖</div>
            <div class="bubble-content">
              <strong>Cloudi:</strong> {{ entry.answer }}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Actions -->
  <div class="actions-center">
    <button onclick="downloadPDF()">📄 Download Chat as PDF</button>
    <button onclick="window.location='/reset'" class="clear-chat-btn">🗑️ Clear Chat History</button>
  </div>

  <!-- Footer -->
  <footer class="cloudi-footer">
    <p>Powered by <strong>Cloud Counselage</strong></p>
    <p>© Vedika Dabade. All rights reserved.</p>
  </footer>

  <!-- Floating Share Bar -->
  <div class="social-share">
    <p>Share</p>
    <div class="social-icons">
      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" rel="noopener" class="facebook" title="Share on Facebook"><i class="fab fa-facebook-f"></i></a>
      <a href="https://twitter.com/intent/tweet?url={{ request.url }}" target="_blank" rel="noopener" class="twitter" title="Share on Twitter"><i class="fab fa-x-twitter"></i></a>
      <a href="https://api.whatsapp.com/send?text={{ request.url }}" target="_blank" rel="noopener" class="whatsapp" title="Share on WhatsApp"><i class="fab fa-whatsapp"></i></a>
      <a href="#" onclick="copyPageLink()" class="share" title="Copy page link"><i class="fas fa-link"></i></a>
    </div>
  </div>

  <!-- Chat Analytics -->
  <div class="analytics-link">
  <a href="/analytics" class="analytics-btn">📊 View Analytics</a>
</div>

  <!-- Scripts -->
  <script>
    const rawAnswer = document.getElementById("cloudi-answer").innerText;
    const answerText = rawAnswer.replace(/[^\w\s.,!?]/g, '').replace(/\s+/g, ' ').trim();

   function speakAnswer(text) {
      const voices = window.speechSynthesis.getVoices();

      const preferredVoices = voices.filter(v =>
        (v.name.toLowerCase().includes("female") ||
        v.name.toLowerCase().includes("samantha") ||
        v.name.toLowerCase().includes("zira") ||
        v.name.toLowerCase().includes("english (india)") ||
        v.name.toLowerCase().includes("google us english"))
        && v.lang.startsWith("en")
      );

      const voice = preferredVoices[0] || voices.find(v => v.lang.startsWith("en"));
      if (!voice) return;

      const speakCloudi = new SpeechSynthesisUtterance();
      speakCloudi.text = text;
      speakCloudi.voice = voice;
      speakCloudi.rate = 0.9;
      speakCloudi.pitch = 1.2;  // softer and higher
      speakCloudi.volume = 1;

      window.speechSynthesis.speak(speakCloudi);
    }

    function toggleVoice() {
      const icon = document.getElementById("voice-toggle");
      const muted = localStorage.getItem("cloudiMuted") === "true";
      localStorage.setItem("cloudiMuted", (!muted).toString());
      icon.textContent = muted ? "🔊" : "🔇";
      if (!muted) speechSynthesis.cancel();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('darkMode', isDark);
      document.getElementById("theme-toggle").textContent = isDark ? "☀️" : "🌙";
    }

    function copyToClipboard() {
      navigator.clipboard.writeText(answerText)
        .then(() => alert("Copied to clipboard! ✅"))
        .catch(() => alert("Failed to copy ❌"));
    }

    function toggleHistory() {
      const history = document.getElementById("history-container");
      const btn = document.getElementById("toggle-history");
      const isOpen = history.style.display === "block";
      history.style.display = isOpen ? "none" : "block";
      btn.textContent = isOpen ? "📂 Show Chat History" : "❌ Hide Chat History";
    }

    function toggleFaq(el) {
      const answer = el.nextElementSibling;
      const open = answer.style.display === "block";
      answer.style.display = open ? "none" : "block";
      el.innerHTML = (open ? "▶️" : "🔽") + el.innerHTML.slice(1);
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 20;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("Cloudi Chat History ☁️", 20, y);
      y += 10;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(12);
      const chat = JSON.parse('{{ history|tojson|safe }}');
      chat.forEach(entry => {
        y += 10;
        doc.text("You: " + entry.question, 20, y);
        y += 7;
        doc.text("Cloudi: " + entry.answer, 20, y, { maxWidth: 170 });
      });
      if (!chat.length) return alert("No chat history found to download!");
      doc.save("Cloudi_Chat_History.pdf");
    }

    function openFeedbackModal() {
      document.getElementById("feedback-modal").style.display = "block";
    }

    function closeFeedbackModal() {
      document.getElementById("feedback-modal").style.display = "none";
    }

    window.onclick = function(event) {
      const modal = document.getElementById("feedback-modal");
      if (event.target == modal) modal.style.display = "none";
    };

    window.onload = () => {
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) {
        document.body.classList.add('dark');
        document.getElementById("theme-toggle").textContent = "☀️";
      }
      const voiceEnabled = localStorage.getItem("cloudiMuted") !== "true";
      document.getElementById("voice-toggle").textContent = voiceEnabled ? "🔊" : "🔇";
      setTimeout(() => {
        document.getElementById("cloudi-typing").style.display = "none";
        document.getElementById("cloudi-response").style.display = "block";
        if (voiceEnabled) speakAnswer(answerText);
      }, 2000);
    };
  </script>
</body>
</html>
